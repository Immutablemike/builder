.PHONY: help dev build test clean deploy-staging deploy-production

# Default target
help:
	@echo "ToySoldiers Creator Economy Platform"
	@echo ""
	@echo "Available commands:"
	@echo "  dev              - Start local development environment"
	@echo "  build            - Build all services for production"
	@echo "  test             - Run all tests"
	@echo "  test-backend     - Run backend tests only"
	@echo "  test-frontend    - Run frontend tests only"
	@echo "  clean            - Clean up containers and build artifacts"
	@echo "  migrate          - Run database migrations"
	@echo "  seed             - Seed database with sample data"
	@echo "  reset-db         - Reset database (WARNING: destroys data)"
	@echo "  logs             - Show container logs"
	@echo "  deploy-staging   - Deploy to staging environment"
	@echo "  deploy-production - Deploy to production environment"

# Development
dev:
	@echo "ðŸš€ Starting ToySoldiers development environment..."
	docker-compose -f infra/docker-compose.yml up -d
	@echo "âœ… Development environment started!"
	@echo "ðŸ“± Creator App: http://localhost:19006"
	@echo "ðŸ“± Fan App: http://localhost:19007"
	@echo "ðŸŒ Web Dashboard: http://localhost:3000"
	@echo "ðŸ”§ API Gateway: http://localhost:8000"

# Build
build:
	@echo "ðŸ”¨ Building all services..."
	docker-compose -f infra/docker-compose.yml build
	cd frontend/creator_app && npm run build
	cd frontend/fan_app && npm run build
	cd frontend/web && npm run build
	@echo "âœ… All services built successfully!"

# Testing
test: test-backend test-frontend

test-backend:
	@echo "ðŸ§ª Running backend tests..."
	cd backend/core/auth && python -m pytest
	cd backend/core/payments && python -m pytest
	cd backend/core/analytics && python -m pytest
	cd backend/core/content_api && python -m pytest
	cd backend/core/chat && python -m pytest
	@echo "âœ… Backend tests completed!"

test-frontend:
	@echo "ðŸ§ª Running frontend tests..."
	cd frontend/creator_app && npm test
	cd frontend/fan_app && npm test
	cd frontend/web && npm test
	@echo "âœ… Frontend tests completed!"

# Database operations
migrate:
	@echo "ðŸ“Š Running database migrations..."
	cd database && ./migrate_db.sh
	@echo "âœ… Database migrations completed!"

seed:
	@echo "ðŸŒ± Seeding database with sample data..."
	cd database && psql $(DATABASE_URL) -f seed_data.sql
	@echo "âœ… Database seeded successfully!"

reset-db:
	@echo "âš ï¸  WARNING: This will destroy all data!"
	@read -p "Are you sure? [y/N] " confirm && [ "$$confirm" = "y" ]
	cd database && psql $(DATABASE_URL) -f reset.sql
	$(MAKE) migrate
	$(MAKE) seed
	@echo "âœ… Database reset completed!"

# Deployment
deploy-staging:
	@echo "ðŸš€ Deploying to staging environment..."
	./scripts/deploy.sh staging
	@echo "âœ… Staging deployment completed!"

deploy-production:
	@echo "ðŸš€ Deploying to production environment..."
	@echo "âš ï¸  WARNING: Production deployment!"
	@read -p "Are you sure? [y/N] " confirm && [ "$$confirm" = "y" ]
	./scripts/deploy.sh production
	@echo "âœ… Production deployment completed!"

# Monitoring
logs:
	@echo "ðŸ“‹ Showing container logs..."
	docker-compose -f infra/docker-compose.yml logs -f

health:
	@echo "ðŸ¥ Checking service health..."
	curl -f http://localhost:8001/health && echo "âœ… Auth service healthy"
	curl -f http://localhost:8002/health && echo "âœ… Payment service healthy"
	curl -f http://localhost:8003/health && echo "âœ… Analytics service healthy"
	curl -f http://localhost:8004/health && echo "âœ… Content API healthy"
	curl -f http://localhost:8005/health && echo "âœ… Chat service healthy"

# Cleanup
clean:
	@echo "ðŸ§¹ Cleaning up..."
	docker-compose -f infra/docker-compose.yml down -v
	docker system prune -f
	@echo "âœ… Cleanup completed!"

# Quick start
quickstart:
	@echo "âš¡ Quick start - setting up everything..."
	cp .env.example .env
	@echo "ðŸ“ Please edit .env with your configuration"
	@echo "âš¡ After editing .env, run: make dev"

# Development tools
format:
	@echo "ðŸ’… Formatting code..."
	cd backend && black . && isort .
	cd frontend && npm run format
	@echo "âœ… Code formatted!"

lint:
	@echo "ðŸ” Linting code..."
	cd backend && flake8 . && mypy .
	cd frontend && npm run lint
	@echo "âœ… Linting completed!"

# Documentation
docs:
	@echo "ðŸ“š Generating documentation..."
	cd docs && mkdocs build
	@echo "âœ… Documentation generated!"

docs-serve:
	@echo "ðŸ“š Serving documentation locally..."
	cd docs && mkdocs serve

# SDK generation
generate-sdk:
	@echo "ðŸ”§ Generating client SDKs..."
	./scripts/generate_sdk.sh
	@echo "âœ… SDKs generated!"

# Backup
backup:
	@echo "ðŸ’¾ Creating database backup..."
	pg_dump $(DATABASE_URL) > backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup created!"