# .github/workflows/generate_from_brief.yml
# GitHub Compliance: Latest action versions, proper indentation, security
name: Generate Project from Brief

on:
  workflow_run:
    workflows: ["00 Validate Manifest"]
    types: [completed]
  pull_request:
    paths: ["briefs/*_Stack.yaml"]
  workflow_dispatch:
    inputs:
      brief_file:
        description: "Brief file to process"
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  validate:
    name: Validate Brief Files
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      
      - name: Install validation tools
        run: |
          pip install --upgrade pip
          pip install pyyaml jsonschema
      
      - name: Validate YAML syntax
        run: |
          for file in briefs/*_Stack.yaml; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              python -c "import yaml; yaml.safe_load(open('$file'))"
            fi
          done

  generate:
    name: Generate Project Structure
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml jinja2
      
      - name: Detect changed brief
        id: brief
        run: |
          if [ "${{ github.event.inputs.brief_file }}" != "" ]; then
            echo "brief=${{ github.event.inputs.brief_file }}" >> $GITHUB_OUTPUT
          else
            # Detect changed brief file from git diff
            BRIEF=$(git diff --name-only HEAD~1 HEAD | grep "briefs/.*_Stack.yaml" | head -1)
            if [ -z "$BRIEF" ]; then
              # Fallback to all brief files for PR events
              BRIEF=$(find briefs -name "*_Stack.yaml" | head -1)
            fi
            echo "brief=$BRIEF" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate brief file exists
        run: |
          if [ ! -f "${{ steps.brief.outputs.brief }}" ]; then
            echo "❌ Brief file not found: ${{ steps.brief.outputs.brief }}"
            exit 1
          fi
          echo "✅ Processing brief: ${{ steps.brief.outputs.brief }}"
      
      - name: Generate project structure
        run: |
          python tools/project_generator.py "${{ steps.brief.outputs.brief }}"
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: List generated files
        run: |
          echo "Generated project structure:"
          find *_complete -type f | head -20
      
      - name: Archive generated project
        uses: actions/upload-artifact@v4
        with:
          name: generated-project-${{ github.run_number }}
          path: "*_complete/"
          retention-days: 30
          compression-level: 6
      
      - name: Commit generated project
        if: github.event_name == 'push'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add "*_complete/"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Generate project from ${{ steps.brief.outputs.brief }}"
            git push
          fi

  quality-check:
    name: Quality Check Generated Projects
    runs-on: ubuntu-latest
    needs: generate
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download generated artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-project-${{ github.run_number }}
      
      - name: Validate generated structure
        run: |
          for project in *_complete; do
            if [ -d "$project" ]; then
              echo "Checking $project structure..."
              test -f "$project/README.md" || (echo "❌ Missing README.md" && exit 1)
              test -d "$project/.github" || (echo "❌ Missing .github directory" && exit 1)
              test -f "$project/Makefile" || (echo "❌ Missing Makefile" && exit 1)
              echo "✅ $project structure valid"
            fi
          done