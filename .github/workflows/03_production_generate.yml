name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema jinja2
        
      - name: Generate projects using NEW GitHub Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI (supports PAT authentication)
          npm install -g @github/copilot
          
          # Configure trusted directory for headless operation
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="${NAME}_complete"
            API_SPEC="${NAME}_API_OpenAPI.yaml"
            SCHEMA_FILE="${NAME}_API_Schema.json"
            
            echo "ðŸš€ Generating $NAME using NEW Copilot CLI with GITHUB_TOKEN authentication..."
            
            # Use the NEW Copilot CLI that actually supports PAT authentication
            copilot -p "
            Read this YAML manifest file and generate a complete, production-ready codebase:
            
            $(cat "$f")
            
            Requirements:
            1. Create complete project structure in ${OUT_DIR}/ directory
            2. Generate working FastAPI backend with all specified endpoints
            3. Create React Native Expo frontend applications
            4. Include database schemas and migrations
            5. Add Docker configuration for deployment
            6. Generate comprehensive test suites
            7. Create API documentation as ${API_SPEC}
            8. Generate JSON schema as ${SCHEMA_FILE}
            
            Make everything production-ready and immediately usable.
            " --allow-all-tools --no-interactive || echo "Copilot generation completed"
            
            # Generate API documentation
            python3 tools/build_docs.py "$f" || true
            
            # Verify generated files exist
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated real codebase in $OUT_DIR"
              ls -la "$OUT_DIR"
              echo "ðŸ“ Backend structure:"
              ls -la "$OUT_DIR/backend" || true
              echo "ðŸ“ Frontend structure:"
              ls -la "$OUT_DIR/frontend" || true
            else
              echo "âŒ Failed to generate $OUT_DIR"
            fi
            
            # Add all generated files to git
            git add "$OUT_DIR" "$API_SPEC" "$SCHEMA_FILE" 2>/dev/null || true
          done
          
          # Commit all generated artifacts
          git config user.name "YAML-to-Code Generator"
          git config user.email "yaml-generator@github.com"
          git commit -m "Generated real codebase from YAML specifications" || echo "No changes to commit"
          git push