name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  contents: write
  actions: read

jobs:
  generate:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || contains(github.event.comment.body, '‚úÖ') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Generate deterministic codebase from YAML
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI
          npm install -g @github/copilot
          
          # Configure Trusted Environment for headless CI/CD
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="${NAME}_complete"
            
            # Clean any existing output for fresh generation and workspace isolation
            rm -rf "$OUT_DIR" 2>/dev/null || true
            mkdir -p "$OUT_DIR"
            
            # Extract project metadata from YAML (handle both project_meta and project structures)
            PROJECT_NAME=$(python3 -c "import yaml; spec = yaml.safe_load(open('$f')); print(spec.get('project_meta', {}).get('name', spec.get('project', '$NAME')))")
            
            echo "üöÄ Generating $OUT_DIR for project: $PROJECT_NAME"
            echo "üìñ Processing $(wc -c < "$f") character YAML manifest..."
            
            # Generate with NEW Copilot CLI in headless mode
            cd "$OUT_DIR"
            copilot -p "You are a YAML-to-Codebase Factory. Generate a complete codebase for project '$PROJECT_NAME' based on this YAML specification. Write all files in current directory. No placeholders, no TODO comments. YAML spec: $(cat ../$f)" --allow-all-tools
            cd ..
            
            # Verify and report generation results
            if [ -d "$OUT_DIR" ]; then
              echo "‚úÖ Generated $OUT_DIR with $(find "$OUT_DIR" -type f | wc -l) files"
              ls -la "$OUT_DIR"
              git add "$OUT_DIR" 2>/dev/null || true
            else
              echo "‚ùå Failed to generate $OUT_DIR"
              ls -la .
            fi
          done
          
          # Commit generated codebase
          git config user.name "YAML Factory"
          git config user.email "factory@toysoldiers.space"
          git commit -m "Generate deterministic codebase from YAML specification" || echo "No changes"
          git push