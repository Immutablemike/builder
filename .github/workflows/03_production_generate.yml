name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Generate deterministic codebase from YAML
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI
          npm install -g @github/copilot
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="${NAME,,}"
            
            # Clean any existing output for fresh generation
            rm -rf "$OUT_DIR" 2>/dev/null || true
            
            echo "ğŸš€ Generating $OUT_DIR from YAML specification..."
            echo "ğŸ“– Processing $(wc -c < "$f") character YAML manifest..."
            
            # Generate using simplified prompt approach
            copilot -p "You are a YAML-to-Codebase Factory. Read the provided YAML repo_tree section and generate EXACTLY that directory structure with working FastAPI + Expo code. No placeholders, no TODO comments. Generate complete ToySoldiers platform from YAML specification: $(cat "$f")" --allow-all-tools
            
            # Verify and report generation results
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated $OUT_DIR with $(find "$OUT_DIR" -type f | wc -l) files"
              ls -la "$OUT_DIR"
              git add "$OUT_DIR" 2>/dev/null || true
            else
              echo "âŒ Failed to generate $OUT_DIR"
              ls -la .
            fi
          done
          
          # Commit generated codebase
          git config user.name "YAML Factory"
          git config user.email "factory@toysoldiers.space"
          git commit -m "Generate deterministic codebase from YAML specification" || echo "No changes"
          git push