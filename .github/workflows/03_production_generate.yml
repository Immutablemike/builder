name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema jinja2
        
      - name: Generate projects using Python generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="${NAME}_complete"
            API_SPEC="${NAME}_API_OpenAPI.yaml"
            SCHEMA_FILE="${NAME}_API_Schema.json"
            
            echo "ðŸš€ Generating $NAME from manifest..."
            
            # Use Python project generator instead of Copilot CLI
            python3 tools/project_generator.py "$f" || echo "Generation completed with warnings"
            
            # Generate API documentation
            python3 tools/build_docs.py "$f" || true
            
            # Verify generated files exist
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated codebase in $OUT_DIR"
              ls -la "$OUT_DIR"
            else
              echo "âŒ Failed to generate $OUT_DIR"
            fi
            
            # Add all generated files to git
            git add "$OUT_DIR" "$API_SPEC" "$SCHEMA_FILE" 2>/dev/null || true
          done
          
          # Commit all generated artifacts
          git config user.name "GitHub Copilot CLI"
          git config user.email "copilot-cli@github.com"
          git commit -m "Auto-generated codebases via new Copilot CLI" || echo "No changes to commit"
          git push