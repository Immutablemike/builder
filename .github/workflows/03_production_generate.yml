name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema jinja2
        
      - name: Generate projects using NEW GitHub Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI (supports PAT authentication)
          npm install -g @github/copilot
          
          # Configure trusted directory for headless operation
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="Toy_Soldiers_completedly_agentic"
            API_SPEC="${NAME}_API_OpenAPI.yaml"
            SCHEMA_FILE="${NAME}_API_Schema.json"
            
            echo "ðŸš€ Generating ${NAME} using NEW Copilot CLI with GITHUB_TOKEN authentication..."
            echo "ðŸ“– Processing $(wc -c < "$f") character YAML manifest..."
            
            # Use the NEW Copilot CLI with the complete YAML content
            copilot -p "
            You are an expert full-stack developer. Read this comprehensive YAML manifest and generate a complete, production-ready ToySoldiers platform codebase.
            
            YAML MANIFEST CONTENT:
            $(cat "$f")
            
            REQUIREMENTS:
            1. Create complete project in Toy_Soldiers_completedly_agentic/ directory at repository root
            2. Follow ALL specifications in the YAML manifest exactly
            3. Generate working FastAPI backend services for each component:
               - backend/core/auth/ (Supabase + FastAPI auth gateway)
               - backend/core/payments/ (Stripe Connect integration) 
               - backend/core/analytics/ (PostHog + metrics)
               - backend/core/content_api/ (CRUD + media transcoding)
               - backend/core/chat/ (Comments + live chat)
               - backend/creator/ (Creator workflow services)
               - backend/fan/ (Fan workflow services)
               - backend/gateway/ (API gateway + routing)
            4. Create React Native Expo frontend applications:
               - frontend/creator_app/ (iOS/Android creator app)
               - frontend/fan_app/ (iOS/Android fan app)
               - frontend/shared_ui/ (Reusable components)
               - frontend/web/ (Optional Next.js dashboard)
            5. Generate complete database schemas in database/:
               - schema.sql with all tables (users, content, comments, tips)
               - seed_data.sql
               - migration files
            6. Create infrastructure configuration:
               - docker-compose.yml for local development
               - terraform/ for Cloudflare, Supabase, Stripe
               - caddy/ configuration
            7. Generate deployment and automation:
               - .github/workflows/ for CI/CD
               - scripts/ for deployment and management
               - clients/ for auto-generated SDKs
            8. Create comprehensive documentation:
               - README.md with complete setup instructions
               - API documentation as ${API_SPEC}
               - JSON schema as ${SCHEMA_FILE}
               - docs/ folder with architecture diagrams
            
            IMPLEMENTATION DETAILS:
            - Use FastAPI with async/await for all backend services
            - Use Expo SDK 50+ for React Native apps
            - Use Supabase for authentication and database
            - Use Cloudflare R2 for media storage
            - Use Stripe Connect for payments
            - Use LiveKit for live streaming
            - Use PostHog for analytics
            - Include comprehensive error handling
            - Add proper logging and monitoring
            - Generate working Docker configurations
            - Create proper CI/CD workflows
            - Include security best practices
            
            Generate COMPLETE, WORKING, PRODUCTION-READY code - no templates, no placeholders, no TODOs.
            Make everything immediately runnable and deployable.
            " --allow-all-tools --no-interactive || echo "Copilot generation completed"
            
            # Generate API documentation
            python3 tools/build_docs.py "$f" || true
            
            # Verify generated files exist
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated real codebase in $OUT_DIR"
              ls -la "$OUT_DIR"
              echo "ðŸ“ Backend structure:"
              ls -la "$OUT_DIR/backend" || true
              echo "ðŸ“ Frontend structure:"
              ls -la "$OUT_DIR/frontend" || true
            else
              echo "âŒ Failed to generate $OUT_DIR"
            fi
            
            # Add all generated files to git
            git add "$OUT_DIR" "$API_SPEC" "$SCHEMA_FILE" 2>/dev/null || true
          done
          
          # Commit all generated artifacts
          git config user.name "YAML-to-Code Generator"
          git config user.email "yaml-generator@github.com"
          git commit -m "Generated real codebase from YAML specifications" || echo "No changes to commit"
          git push