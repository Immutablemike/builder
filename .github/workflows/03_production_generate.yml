name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22 (Required for new Copilot CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install New GitHub Copilot CLI
        run: npm install -g @github/copilot
        
      - name: Configure Copilot CLI Trusted Directory
        run: |
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema
        
      - name: Run New Copilot CLI for each approved manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="${NAME}_complete"
            API_SPEC="${NAME}_API_OpenAPI.yaml"
            SCHEMA_FILE="${NAME}_API_Schema.json"
            
            mkdir -p "$OUT_DIR"
            
            echo "ðŸš€ Generating $NAME using new Copilot CLI..."
            
            # Generate comprehensive codebase using new Copilot CLI
            copilot -p "
            Read the YAML manifest at $f and generate a complete, production-ready codebase.
            
            Requirements:
            1. Follow all specifications in the YAML manifest exactly
            2. Create proper project structure with all necessary files
            3. Generate working code with proper error handling and validation
            4. Include comprehensive API documentation
            5. Create deployment configuration files (Dockerfile, docker-compose.yml)
            6. Generate complete test suites for all components
            7. Save everything in $OUT_DIR/ directory
            8. Create OpenAPI specification and save as $API_SPEC
            9. Generate JSON schema validation and save as $SCHEMA_FILE
            10. Ensure all code is production-ready and immediately usable
            11. Include proper logging, monitoring, and health checks
            12. Generate complete README with setup and usage instructions
            
            The generated codebase should be a complete, deployable application that matches the YAML specification exactly.
            " --allow-all-tools || echo "Generation completed with warnings"
            
            # Verify generated files exist
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated codebase in $OUT_DIR"
              ls -la "$OUT_DIR"
            else
              echo "âŒ Failed to generate $OUT_DIR"
            fi
            
            # Add all generated files to git
            git add "$OUT_DIR" "$API_SPEC" "$SCHEMA_FILE" 2>/dev/null || true
          done
          
          # Commit all generated artifacts
          git config user.name "GitHub Copilot CLI"
          git config user.email "copilot-cli@github.com"
          git commit -m "Auto-generated codebases via new Copilot CLI" || echo "No changes to commit"
          git push