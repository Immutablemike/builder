name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema jinja2
        
      - name: Generate deterministic codebase from YAML
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI
          npm install -g @github/copilot
          
          # Configure trusted directory for headless operation
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            
            # Use project name from YAML or fallback to filename
            OUT_DIR="${NAME,,}"
            
            # Clean any existing output for fresh generation
            rm -rf "$OUT_DIR" 2>/dev/null || true
            
            echo "ğŸš€ Generating $OUT_DIR from YAML specification..."
            echo "ğŸ“– Processing $(wc -c < "$f") character YAML manifest..."
            
            # Read YAML specification
            YAML_SPEC=$(cat "$f")
            
            # Execute deterministic generation
            copilot -p "You are a YAML-to-Codebase Factory. Generate ONLY what is specified in the repo_tree section of this YAML.

YAML SPECIFICATION:
$YAML_SPEC

DETERMINISTIC RULES:
1. Read the repo_tree section that shows exact directory/file structure
2. Generate EXACTLY those directories and files - no additions, no omissions
3. Create working code based on backend_services, database, and frontend sections
4. Use specified tech stack: FastAPI + Expo + Supabase + Cloudflare
5. NO placeholder code, NO TODO comments, NO carryover from previous structures

Generate complete working ToySoldiers platform from YAML specification." --allow-all-tools
            
            # Verify and report generation results
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated $OUT_DIR with $(find "$OUT_DIR" -type f | wc -l) files"
              ls -la "$OUT_DIR"
              git add "$OUT_DIR" 2>/dev/null || true
            else
              echo "âŒ Failed to generate $OUT_DIR"
              ls -la .
            fi
          done
          
          # Commit generated codebase
          git config user.name "YAML Factory"
          git config user.email "factory@toysoldiers.space"
          git commit -m "Generate deterministic codebase from YAML specification" || echo "No changes"
          git push
