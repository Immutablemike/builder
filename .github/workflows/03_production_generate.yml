name: 03 Production Generate
on:
  workflow_run:
    workflows: ["02 Prepare Confirmation"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Install Python dependencies
        run: pip install pyyaml jsonschema jinja2
        
      - name: Generate projects using NEW GitHub Copilot CLI
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Install the NEW standalone Copilot CLI (supports PAT authentication)
          npm install -g @github/copilot
          
          # Configure trusted directory for headless operation
          mkdir -p ~/.copilot
          echo '{"trusted_folders": ["/github/workspace"]}' > ~/.copilot/config.json
          
          for f in briefs/*_Stack.yaml; do
            NAME=$(basename "$f" _Stack.yaml)
            OUT_DIR="Toy_Soldiers_completedly_agentic"
            API_SPEC="${NAME}_API_OpenAPI.yaml"
            SCHEMA_FILE="${NAME}_API_Schema.json"
            
            echo "ðŸš€ Generating ${NAME} using NEW Copilot CLI with GITHUB_TOKEN authentication..."
            echo "ðŸ“– Processing $(wc -c < "$f") character YAML manifest..."
            
            # Use the NEW Copilot CLI with the complete YAML content
            copilot -p "
            You are an expert full-stack developer. Read this comprehensive YAML manifest and generate a complete, production-ready ToySoldiers platform codebase.
            
            YAML MANIFEST CONTENT:
            $(cat "$f")
            
            CRITICAL REQUIREMENTS - GENERATE EVERYTHING FROM THE YAML:
            
            1. CREATE COMPLETE MODULAR MONOREPO in Toy_Soldiers_completedly_agentic/ directory:
               
               ROOT LEVEL FILES:
               - README.md (comprehensive setup, architecture overview, quick start)
               - PROGRESS.md (project status, milestones, completion tracking)
               - .env.example (all required environment variables from YAML)
               - .gitignore (comprehensive for Python, Node.js, secrets)
               - Makefile (setup, build, test, deploy, lint commands)
               - docker-compose.yml (local development stack)
               - requirements.txt (if Python dependencies needed at root)
               - package.json (if Node.js dependencies needed at root)
               - openapi.yaml (complete API specification)
               - project.json (project metadata and guardrails)
               
            2. BACKEND/ DIRECTORY - Complete FastAPI microservices:
               backend/
               â”œâ”€â”€ core/
               â”‚   â”œâ”€â”€ auth/ (Supabase + FastAPI auth gateway)
               â”‚   â”‚   â”œâ”€â”€ main.py, routes/, models/, tests/, Dockerfile, requirements.txt
               â”‚   â”œâ”€â”€ payments/ (Stripe Connect integration) 
               â”‚   â”‚   â”œâ”€â”€ main.py, routes/, models/, tests/, Dockerfile, requirements.txt
               â”‚   â”œâ”€â”€ analytics/ (PostHog + metrics)
               â”‚   â”‚   â”œâ”€â”€ main.py, collectors/, dashboards/, tests/, Dockerfile, requirements.txt
               â”‚   â”œâ”€â”€ content_api/ (CRUD + media transcoding)
               â”‚   â”‚   â”œâ”€â”€ main.py, routes/, models/, tests/, Dockerfile, requirements.txt
               â”‚   â””â”€â”€ chat/ (Comments + live chat)
               â”‚       â”œâ”€â”€ main.py, routes/, models/, websocket/, tests/, Dockerfile, requirements.txt
               â”œâ”€â”€ creator/ (Creator workflow services)
               â”‚   â”œâ”€â”€ upload_service/, dashboard_service/, profile_service/
               â”œâ”€â”€ fan/ (Fan workflow services)
               â”‚   â”œâ”€â”€ discovery_service/, interaction_service/
               â””â”€â”€ gateway/ (API gateway + routing)
                   â”œâ”€â”€ main.py, routes/, nginx.conf, Dockerfile
               
            3. FRONTEND/ DIRECTORY - Complete Expo + React Native apps:
               frontend/
               â”œâ”€â”€ creator_app/ (Expo app for creators)
               â”‚   â”œâ”€â”€ app.json, package.json, src/screens/, src/components/, src/hooks/, src/utils/
               â”œâ”€â”€ fan_app/ (Expo app for fans)
               â”‚   â”œâ”€â”€ app.json, package.json, src/screens/, src/components/, src/hooks/, src/utils/
               â”œâ”€â”€ shared_ui/ (Reusable components)
               â”‚   â”œâ”€â”€ VideoCard.tsx, CommentBox.tsx, PlayerControls.tsx, TipButton.tsx
               â””â”€â”€ web/ (Optional Next.js dashboard)
                   â”œâ”€â”€ pages/, package.json
               
            4. DATABASE/ DIRECTORY - Complete PostgreSQL schemas:
               database/
               â”œâ”€â”€ schema.sql (all tables: users, creators, content, comments, tips, analytics_views)
               â”œâ”€â”€ seed_data.sql (sample data for development)
               â”œâ”€â”€ migrations/ (001_init.sql, 002_add_comments.sql, 003_add_tips.sql)
               â””â”€â”€ README.md (database setup and migration instructions)
               
            5. INFRA/ DIRECTORY - Complete infrastructure configuration:
               infra/
               â”œâ”€â”€ docker-compose.yml (local development stack)
               â”œâ”€â”€ terraform/ (main.tf, variables.tf for Cloudflare, Supabase, Stripe)
               â”œâ”€â”€ caddy/ (Caddyfile, ssl/)
               â””â”€â”€ README.md (infrastructure setup instructions)
               
            6. CLIENTS/ DIRECTORY - Auto-generated SDKs:
               clients/
               â”œâ”€â”€ typescript/ (openapi.ts)
               â””â”€â”€ python/ (toysoldiers_client/)
               
            7. SCRIPTS/ DIRECTORY - Deployment and management scripts:
               scripts/
               â”œâ”€â”€ deploy.sh, seed_posthog.py, migrate_db.sh, lint_all.sh, generate_sdk.sh
               
            8. DOCS/ DIRECTORY - Comprehensive documentation:
               docs/
               â”œâ”€â”€ ToySoldiers_Stack.yaml (copy of this file)
               â”œâ”€â”€ ToySoldiers_API_OpenAPI.yaml (complete OpenAPI 3.1 spec)
               â”œâ”€â”€ ToySoldiers_API_Schema.json (JSON Schema validation)
               â”œâ”€â”€ creator_flow.md, fan_flow.md
               â””â”€â”€ architecture_diagram.mmd (Mermaid system diagram)
               
            9. .GITHUB/ DIRECTORY - Complete CI/CD workflows:
               .github/workflows/
               â”œâ”€â”€ validate_openapi.yml, build_backend.yml, build_frontend.yml
               â”œâ”€â”€ deploy_staging.yml, deploy_production.yml, generate_sdk.yml, test_suite.yml
            
            IMPLEMENTATION REQUIREMENTS:
            - Use FastAPI with async/await for all backend services
            - Use Expo SDK 50+ for React Native apps  
            - Use Supabase for authentication and database
            - Use Cloudflare R2 for media storage
            - Use Stripe Connect for payments
            - Use LiveKit for live streaming
            - Use PostHog for analytics
            - Include comprehensive error handling and logging
            - Generate working Docker configurations
            - Create complete CI/CD workflows
            - Include security best practices
            - Follow the exact architecture specified in the YAML
            
            CRITICAL: Generate COMPLETE, WORKING, PRODUCTION-READY code - no templates, no placeholders, no TODOs.
            Every file must be immediately runnable and deployable. Follow the YAML specification exactly.
            Create the complete modular monorepo structure as documented in the repo_tree section.
            "
            
            Generate COMPLETE, WORKING, PRODUCTION-READY code - no templates, no placeholders, no TODOs.
            Make everything immediately runnable and deployable.
            " --allow-all-tools || echo "Copilot generation completed"
            
            # Verify generated files exist
            if [ -d "$OUT_DIR" ]; then
              echo "âœ… Generated real codebase in $OUT_DIR"
              ls -la "$OUT_DIR"
              echo "ðŸ“ Backend structure:"
              ls -la "$OUT_DIR/backend" || true
              echo "ðŸ“ Frontend structure:"
              ls -la "$OUT_DIR/frontend" || true
              echo "ðŸ“ Database structure:"
              ls -la "$OUT_DIR/database" || true
              echo "ðŸ“ Infrastructure structure:"
              ls -la "$OUT_DIR/infra" || true
              echo "ðŸ“ Documentation structure:"
              ls -la "$OUT_DIR/docs" || true
            else
              echo "âŒ Failed to generate $OUT_DIR"
            fi
            
            # Add all generated files to git
            git add "$OUT_DIR" 2>/dev/null || true
          done
          
          # Commit all generated artifacts
          git config user.name "YAML-to-Code Generator"
          git config user.email "yaml-generator@github.com"
          git commit -m "Generated real codebase from YAML specifications" || echo "No changes to commit"
          git push