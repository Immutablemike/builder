# Toy Soldiers Platform - Development Makefile
# ============================================

.PHONY: help install dev build test lint format clean validate-api generate-sdk deploy-dev deploy-prod

# Default target
help: ## ğŸ“‹ Show this help message
	@echo "ğŸ¯ Toy Soldiers Platform - Development Commands"
	@echo "=============================================="
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Environment setup
install: ## ğŸ“¦ Install all dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	@if [ -f "package.json" ]; then npm install; fi
	@if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
	@if [ -d "packages/creator-app" ]; then cd packages/creator-app && npm install; fi
	@if [ -d "packages/fan-app" ]; then cd packages/fan-app && npm install; fi
	@if [ -d "packages/shared-components" ]; then cd packages/shared-components && npm install; fi
	@if [ -d "apps/api-server" ]; then cd apps/api-server && pip install -r requirements.txt; fi
	@echo "âœ… Dependencies installed!"

dev: ## ğŸš€ Start development environment
	@echo "ğŸš€ Starting development environment..."
	@echo "ğŸ”§ Starting API server..."
	@if [ -d "apps/api-server" ]; then \
		cd apps/api-server && uvicorn main:app --reload --port 8000 & \
	fi
	@echo "ğŸ“± Starting Creator app..."
	@if [ -d "packages/creator-app" ]; then \
		cd packages/creator-app && npm start & \
	fi
	@echo "ğŸ‘¥ Starting Fan app..."
	@if [ -d "packages/fan-app" ]; then \
		cd packages/fan-app && npm start & \
	fi
	@echo "âœ… Development environment started!"
	@echo "ğŸŒ API Server: http://localhost:8000"
	@echo "ğŸ“± Creator App: http://localhost:19000"
	@echo "ğŸ‘¥ Fan App: http://localhost:19001"

build: ## ğŸ”¨ Build all applications
	@echo "ğŸ”¨ Building applications..."
	@if [ -d "packages/creator-app" ]; then \
		echo "ğŸ“± Building Creator app..." && \
		cd packages/creator-app && npm run build; \
	fi
	@if [ -d "packages/fan-app" ]; then \
		echo "ğŸ‘¥ Building Fan app..." && \
		cd packages/fan-app && npm run build; \
	fi
	@if [ -d "packages/shared-components" ]; then \
		echo "ğŸ§± Building shared components..." && \
		cd packages/shared-components && npm run build; \
	fi
	@if [ -d "apps/web-dashboard" ]; then \
		echo "ğŸŒ Building web dashboard..." && \
		cd apps/web-dashboard && npm run build; \
	fi
	@echo "âœ… Build complete!"

test: ## ğŸ§ª Run all tests
	@echo "ğŸ§ª Running tests..."
	@if [ -d "apps/api-server" ]; then \
		echo "ğŸ”§ Testing API server..." && \
		cd apps/api-server && python -m pytest tests/ -v; \
	fi
	@if [ -d "packages/creator-app" ]; then \
		echo "ğŸ“± Testing Creator app..." && \
		cd packages/creator-app && npm test; \
	fi
	@if [ -d "packages/fan-app" ]; then \
		echo "ğŸ‘¥ Testing Fan app..." && \
		cd packages/fan-app && npm test; \
	fi
	@if [ -d "tests/integration" ]; then \
		echo "ğŸ”— Running integration tests..." && \
		python -m pytest tests/integration/ -v; \
	fi
	@echo "âœ… All tests completed!"

lint: ## ğŸ” Run linting on all code
	@echo "ğŸ” Running linting..."
	@if [ -d "apps/api-server" ]; then \
		echo "ğŸ”§ Linting API server..." && \
		cd apps/api-server && ruff check . && mypy .; \
	fi
	@if [ -d "packages/creator-app" ]; then \
		echo "ğŸ“± Linting Creator app..." && \
		cd packages/creator-app && npm run lint; \
	fi
	@if [ -d "packages/fan-app" ]; then \
		echo "ğŸ‘¥ Linting Fan app..." && \
		cd packages/fan-app && npm run lint; \
	fi
	@echo "âœ… Linting complete!"

format: ## âœ¨ Format all code
	@echo "âœ¨ Formatting code..."
	@if [ -d "apps/api-server" ]; then \
		echo "ğŸ”§ Formatting API server..." && \
		cd apps/api-server && ruff format .; \
	fi
	@if [ -d "packages/creator-app" ]; then \
		echo "ğŸ“± Formatting Creator app..." && \
		cd packages/creator-app && npm run format; \
	fi
	@if [ -d "packages/fan-app" ]; then \
		echo "ğŸ‘¥ Formatting Fan app..." && \
		cd packages/fan-app && npm run format; \
	fi
	@echo "âœ… Code formatting complete!"

clean: ## ğŸ§¹ Clean build artifacts and dependencies
	@echo "ğŸ§¹ Cleaning build artifacts..."
	@find . -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@find . -name "dist" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name "build" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name ".expo" -type d -exec rm -rf {} + 2>/dev/null || true
	@find . -name ".next" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

# API and Schema Operations
validate-api: ## âœ… Validate OpenAPI specification and JSON schemas
	@echo "âœ… Validating API specifications..."
	@if command -v openapi-spec-validator >/dev/null 2>&1; then \
		echo "ğŸ” Validating OpenAPI specification..." && \
		openapi-spec-validator schemas/ToySoldiers_API_OpenAPI.yaml; \
	else \
		echo "âš ï¸  openapi-spec-validator not found. Install with: pip install openapi-spec-validator"; \
	fi
	@if command -v python >/dev/null 2>&1; then \
		echo "ğŸ” Validating JSON Schema..." && \
		python -c "import json, jsonschema; schema=json.load(open('schemas/ToySoldiers_API_Schema.json')); jsonschema.Draft7Validator.check_schema(schema); print('âœ… JSON Schema is valid!')"; \
	fi
	@echo "âœ… API validation complete!"

generate-sdk: validate-api ## ğŸ“¦ Generate TypeScript and Python SDKs
	@echo "ğŸ“¦ Generating SDKs from OpenAPI specification..."
	@mkdir -p packages/api-client-ts packages/api-client-py
	
	@if command -v openapi-generator-cli >/dev/null 2>&1; then \
		echo "ğŸŸ¦ Generating TypeScript SDK..." && \
		openapi-generator-cli generate \
			-i schemas/ToySoldiers_API_OpenAPI.yaml \
			-g typescript-axios \
			-o packages/api-client-ts \
			--additional-properties=npmName=@toysoldiers/api-client,supportsES6=true; \
	else \
		echo "âš ï¸  openapi-generator-cli not found. Install with: npm install -g @openapitools/openapi-generator-cli"; \
	fi
	
	@if command -v java >/dev/null 2>&1; then \
		echo "ğŸ Generating Python SDK..." && \
		if [ ! -f "openapi-generator-cli.jar" ]; then \
			wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.0.1/openapi-generator-cli-7.0.1.jar -O openapi-generator-cli.jar; \
		fi && \
		java -jar openapi-generator-cli.jar generate \
			-i schemas/ToySoldiers_API_OpenAPI.yaml \
			-g python \
			-o packages/api-client-py \
			--additional-properties=packageName=toysoldiers_api,projectName=toysoldiers-api-client; \
	else \
		echo "âš ï¸  Java not found. Install Java to generate Python SDK"; \
	fi
	
	@echo "âœ… SDK generation complete!"

# Database Operations
db-setup: ## ğŸ—„ï¸ Set up database schema
	@echo "ğŸ—„ï¸ Setting up database schema..."
	@if [ -f "schemas/database/schema.sql" ]; then \
		echo "ğŸ“‹ Database schema found. Run with your preferred database client." && \
		echo "ğŸ”— Supabase: Upload to SQL Editor" && \
		echo "ğŸ˜ PostgreSQL: psql -f schemas/database/schema.sql" && \
		echo "ğŸ“Š File: schemas/database/schema.sql"; \
	else \
		echo "âš ï¸  Database schema not found. Check schemas/database/ directory"; \
	fi

db-migrate: ## ğŸ”„ Run database migrations
	@echo "ğŸ”„ Running database migrations..."
	@if [ -d "schemas/database/migrations" ]; then \
		echo "ğŸ“‚ Migrations directory found: schemas/database/migrations/" && \
		echo "ğŸ”— Apply migrations using your database migration tool"; \
	else \
		echo "âš ï¸  No migrations directory found"; \
	fi

# Docker Operations
docker-build: ## ğŸ³ Build Docker images
	@echo "ğŸ³ Building Docker images..."
	@if [ -f "infrastructure/docker/Dockerfile.api" ]; then \
		echo "ğŸ”§ Building API server image..." && \
		docker build -f infrastructure/docker/Dockerfile.api -t toysoldiers/api:latest .; \
	fi
	@if [ -f "infrastructure/docker/Dockerfile.web" ]; then \
		echo "ğŸŒ Building web dashboard image..." && \
		docker build -f infrastructure/docker/Dockerfile.web -t toysoldiers/web:latest .; \
	fi
	@echo "âœ… Docker images built!"

docker-dev: ## ğŸ³ Start development environment with Docker
	@echo "ğŸ³ Starting development environment with Docker..."
	@if [ -f "infrastructure/docker/docker-compose.yml" ]; then \
		cd infrastructure/docker && docker-compose up -d; \
	else \
		echo "âš ï¸  docker-compose.yml not found in infrastructure/docker/"; \
	fi

docker-down: ## ğŸ³ Stop Docker development environment
	@echo "ğŸ³ Stopping Docker development environment..."
	@if [ -f "infrastructure/docker/docker-compose.yml" ]; then \
		cd infrastructure/docker && docker-compose down; \
	fi

# Deployment Operations
deploy-dev: ## ğŸš€ Deploy to development environment
	@echo "ğŸš€ Deploying to development environment..."
	@echo "ğŸ”§ Building applications..."
	@$(MAKE) build
	@echo "ğŸ§ª Running tests..."
	@$(MAKE) test
	@echo "âœ… Validating API..."
	@$(MAKE) validate-api
	@echo "ğŸš€ Development deployment complete!"
	@echo "ğŸ“‹ Manual steps required:"
	@echo "  - Update environment variables"
	@echo "  - Deploy to staging server"
	@echo "  - Run integration tests"

deploy-prod: ## ğŸš€ Deploy to production environment
	@echo "ğŸš€ Deploying to production environment..."
	@echo "âš ï¸  Production deployment requires manual approval!"
	@echo "ğŸ“‹ Pre-deployment checklist:"
	@echo "  âœ… All tests passing"
	@echo "  âœ… API validation successful"
	@echo "  âœ… Security scan completed"
	@echo "  âœ… Staging environment tested"
	@echo "  âœ… Database migrations reviewed"
	@echo "  âœ… Environment variables updated"
	@echo ""
	@echo "ğŸš€ Run deployment pipeline: GitHub Actions -> Deploy to Production"

# Security Operations
security-scan: ## ğŸ”’ Run security scanning
	@echo "ğŸ”’ Running security scans..."
	@if command -v bandit >/dev/null 2>&1; then \
		echo "ğŸ Scanning Python code with bandit..." && \
		find . -name "*.py" -path "./apps/api-server/*" -exec bandit {} \; 2>/dev/null || true; \
	fi
	@if command -v npm >/dev/null 2>&1; then \
		echo "ğŸ“¦ Scanning npm packages..." && \
		if [ -f "package.json" ]; then npm audit; fi; \
	fi
	@echo "ğŸ” Checking for secrets in code..."
	@if grep -r "password\|secret\|key\|token" . --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" --exclude="Makefile" 2>/dev/null; then \
		echo "âš ï¸  WARNING: Potential secrets found in code!"; \
	else \
		echo "âœ… No obvious secrets found"; \
	fi
	@echo "âœ… Security scan complete!"

# Documentation Operations
docs: ## ğŸ“š Generate documentation
	@echo "ğŸ“š Generating documentation..."
	@if command -v redocly >/dev/null 2>&1; then \
		echo "ğŸ“ Generating API documentation..." && \
		redocly build-docs schemas/ToySoldiers_API_OpenAPI.yaml --output docs/api-docs.html; \
	fi
	@echo "ğŸ“‹ Documentation files:"
	@echo "  ğŸ“ Repository Structure: docs/Repository_Structure.md"
	@echo "  ğŸ—„ï¸  Database Schema: docs/Database_Schema.md"
	@echo "  ğŸ”Œ API Specification: schemas/ToySoldiers_API_OpenAPI.yaml"
	@echo "  ğŸ“Š Master Architecture: docs/ToySoldiers_Stack.yaml"
	@echo "âœ… Documentation generation complete!"

# Monitoring and Analytics
logs: ## ğŸ“Š Show application logs
	@echo "ğŸ“Š Application logs:"
	@if [ -d "logs" ]; then \
		echo "ğŸ“‚ Log directory found: logs/" && \
		ls -la logs/; \
	else \
		echo "ğŸ“‹ No local logs directory found"; \
	fi
	@echo "ğŸ”— Check cloud logs:"
	@echo "  - Cloudflare Analytics: https://dash.cloudflare.com/analytics"
	@echo "  - Supabase Logs: https://app.supabase.com/project/YOUR_PROJECT/logs"
	@echo "  - Hetzner Monitoring: Server dashboard"

status: ## ğŸ“Š Show system status
	@echo "ğŸ“Š Toy Soldiers Platform Status"
	@echo "==============================="
	@echo "ğŸ¯ Project: Toy Soldiers Platform"
	@echo "ğŸ—ï¸  Architecture: SupaNERN Stack"
	@echo "â˜ï¸  Infrastructure: Cloudflare + Hetzner + Supabase"
	@echo ""
	@echo "ğŸ“‚ Components:"
	@if [ -d "packages/creator-app" ]; then echo "  âœ… Creator App"; else echo "  âŒ Creator App"; fi
	@if [ -d "packages/fan-app" ]; then echo "  âœ… Fan App"; else echo "  âŒ Fan App"; fi
	@if [ -d "apps/api-server" ]; then echo "  âœ… API Server"; else echo "  âŒ API Server"; fi
	@if [ -f "schemas/ToySoldiers_API_OpenAPI.yaml" ]; then echo "  âœ… API Schema"; else echo "  âŒ API Schema"; fi
	@echo ""
	@echo "ğŸ”— Quick Links:"
	@echo "  ğŸ“š Documentation: docs/README.md"
	@echo "  ğŸ”Œ API Spec: schemas/ToySoldiers_API_OpenAPI.yaml"
	@echo "  ğŸ—ï¸  Architecture: docs/ToySoldiers_Stack.yaml"

# Environment Management
env-setup: ## âš™ï¸ Set up environment variables
	@echo "âš™ï¸ Setting up environment variables..."
	@if [ ! -f ".env" ]; then \
		if [ -f ".env.example" ]; then \
			echo "ğŸ“‹ Copying .env.example to .env..." && \
			cp .env.example .env && \
			echo "âœ… Environment file created!"; \
		else \
			echo "âš ï¸  No .env.example found. Create environment variables manually."; \
		fi; \
	else \
		echo "âœ… .env file already exists"; \
	fi
	@echo "ğŸ“ Required environment variables:"
	@echo "  ğŸ” SUPABASE_URL, SUPABASE_ANON_KEY"
	@echo "  ğŸ’³ STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET"
	@echo "  â˜ï¸  CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID"
	@echo "  ğŸ“¹ LIVEKIT_API_KEY, LIVEKIT_API_SECRET"

# Quick development shortcuts
quick-start: install env-setup validate-api ## ğŸš€ Quick project setup
	@echo "ğŸš€ Quick Start Complete!"
	@echo "========================"
	@echo "âœ… Dependencies installed"
	@echo "âœ… Environment configured"
	@echo "âœ… API validated"
	@echo ""
	@echo "ğŸ¯ Next steps:"
	@echo "  1. Update .env with your API keys"
	@echo "  2. Run 'make dev' to start development"
	@echo "  3. Visit http://localhost:8000/docs for API docs"

all: clean install build test validate-api ## ğŸ¯ Run complete build pipeline
	@echo "ğŸ¯ Complete build pipeline finished!"
	@echo "âœ… All tasks completed successfully!"